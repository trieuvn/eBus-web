<!DOCTYPE html>
<html lang="vi" class="light">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Create New Booking - Bus Admin</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#1e40af",
                        "background-light": "#f8f9fa",
                        "background-dark": "#0f172a",
                        "text-light": "#f1f5f9",
                        "text-dark": "#1e293b"
                    }
                }
            },
            corePlugins: { preflight: false }
        };
    </script>
    <style>
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

            ::-webkit-scrollbar-thumb:hover {
                background: #94a3b8;
            }

        .dark ::-webkit-scrollbar-thumb {
            background: #475569;
        }

        input:focus, select:focus {
            box-shadow: 0 0 0 3px rgba(30,64,175,0.3);
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 8px;
            color: white;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.4s;
        }

        .toast-success {
            background: #10b981;
        }

        .toast-error {
            background: #ef4444;
        }

        .toast.show {
            opacity: 1;
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark text-text-dark dark:text-text-light min-h-screen flex flex-col transition-colors duration-200 font-sans">
    <!-- Toast container -->
    <div id="toastContainer"></div>

    <main class="flex-1 p-4 md:p-8 lg:px-32 lg:py-12">
        <div class="max-w-6xl mx-auto space-y-8">
            <!-- Breadcrumbs -->
            <nav class="flex items-center text-sm text-gray-500 dark:text-gray-400">
                <a href="/" class="hover:text-primary">Home</a>
                <span class="mx-2">/</span>
                <a href="/Admin/Booking" class="hover:text-primary">Bookings</a>
                <span class="mx-2">/</span>
                <span class="font-semibold">Create New</span>
            </nav>

            <!-- Header -->
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-6">
                <div>
                    <h1 class="text-3xl md:text-4xl font-black tracking-tight">Create New Booking</h1>
                    <p class="mt-2 text-gray-600 dark:text-gray-400">Fill in the details below to generate a new bus ticket reservation.</p>
                </div>
                <div class="flex gap-4">
                    <a href="/Admin/Booking" class="px-6 py-2.5 bg-gray-100 dark:bg-gray-700 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 transition">
                        Cancel
                    </a>
                    <button id="confirmBookingBtn" class="px-6 py-2.5 bg-red-600 text-white rounded-full hover:bg-red-700 transition disabled:opacity-60 flex items-center gap-2">
                        <span class="material-symbols-outlined animate-spin hidden" id="loadingSpinner">refresh</span>
                        Confirm Booking
                    </button>
                </div>
            </div>

            <form id="bookingForm" class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Left Column -->
                <div class="lg:col-span-2 space-y-8">
                    <!-- Trip Information -->
                    <section class="bg-white dark:bg-gray-900 rounded-xl shadow-md overflow-hidden">
                        <div class="px-6 py-4 bg-gray-50 dark:bg-gray-800 flex items-center gap-3 border-b dark:border-gray-700">
                            <span class="material-symbols-outlined text-red-600 text-2xl">directions_bus</span>
                            <h2 class="text-xl font-bold">Trip Information</h2>
                        </div>
                        <div class="p-6 grid md:grid-cols-2 gap-6">
                            <label class="block">
                                <span class="text-sm font-medium mb-1.5 block">Customer (User ID)</span>
                                <select id="contactName" class="form-select" style="width:100%">
                                    <option value="">Search by name or ID...</option>
                                </select>
                            </label>
                            <label class="block">
                                <span class="text-sm font-medium mb-1.5 block">Select Trip (Route & Date)</span>
                                <select id="routeSelect" class="w-full p-3 rounded-lg border dark:bg-gray-800 dark:border-gray-600 focus:border-primary">
                                    <option value="">Search route number...</option>
                                    @foreach (var r in ViewBag.Routes)
                                    {
                                        <option value="@r.Id">@r.Name</option>
                                    }
                                </select>
                            </label>
                            <label class="block">
                                <span class="text-sm font-medium mb-1.5 block">Pickup Stop</span>
                                <select id="pickupStop" class="w-full p-3 rounded-lg border dark:bg-gray-800 dark:border-gray-600" disabled>
                                    <option value="">Select pickup point</option>
                                </select>
                            </label>
                            <label class="block">
                                <span class="text-sm font-medium mb-1.5 block">Dropoff Stop</span>
                                <select id="dropoffStop" class="w-full p-3 rounded-lg border dark:bg-gray-800 dark:border-gray-600" disabled>
                                    <option value="">Select dropoff point</option>
                                </select>
                            </label>
                        </div>
                    </section>

                    <!-- Passenger Details -->
                    <section class="bg-white dark:bg-gray-900 rounded-xl shadow-md overflow-hidden">
                        <div class="px-6 py-4 bg-gray-50 dark:bg-gray-800 flex items-center justify-between border-b dark:border-gray-700">
                            <h2 class="text-xl font-bold flex items-center gap-3">
                                <span class="material-symbols-outlined text-red-600 text-2xl">groups</span>
                                Passenger Details
                            </h2>
                            <button type="button" id="addPassengerBtn" class="px-4 py-2 bg-red-50 text-red-600 rounded-full hover:bg-red-100 transition text-sm font-medium flex items-center gap-2">
                                <span class="material-symbols-outlined text-base">add</span> Add Passenger
                            </button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-50 dark:bg-gray-800/50">
                                    <tr class="text-left text-gray-600 dark:text-gray-400 text-xs uppercase">
                                        <th class="px-6 py-4">Passenger Name</th>
                                        <th class="px-6 py-4">Gender</th>
                                        <th class="px-6 py-4">Seat No.</th>
                                        <th class="px-6 py-4 text-right">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="passengerTableBody" class="divide-y dark:divide-gray-700">
                                    <!-- Rows added dynamically -->
                                </tbody>
                            </table>
                        </div>
                        <div class="px-6 py-4 text-xs text-gray-500 dark:text-gray-400 bg-gray-50 dark:bg-gray-900/50">
                            <span class="text-red-600 font-bold">*</span> Please ensure all passenger details match their government ID.
                        </div>
                    </section>
                </div>

                <!-- Right Column - Summary -->
                <aside class="lg:col-span-1">
                    <div class="bg-white dark:bg-gray-900 rounded-xl shadow-md p-6 sticky top-8 space-y-6">
                        <h2 class="text-xl font-bold flex items-center gap-3">
                            <span class="material-symbols-outlined text-red-600">receipt_long</span>
                            Booking Summary
                        </h2>
                        <div class="space-y-6">
                            <div>
                                <label class="text-sm font-medium block mb-2">Contact Name</label>
                                <input id="summaryContactName" type="text" readonly class="w-full p-3 rounded-lg border dark:bg-gray-800 dark:border-gray-600 bg-gray-50" placeholder="Jane Doe" />
                            </div>
                            <div>
                                <span class="text-sm font-medium block mb-2">Booking Status</span>
                                <div class="space-y-2">
                                    <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-red-50 transition border-red-200 bg-red-50">
                                        <input type="radio" name="status" value="1" checked class="mr-3 accent-red-600" />
                                        <span class="w-2 h-2 rounded-full bg-green-500 mr-2"></span>
                                        <span class="text-sm">Confirmed</span>
                                    </label>
                                    <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50 transition">
                                        <input type="radio" name="status" value="0" class="mr-3 accent-red-600" />
                                        <span class="w-2 h-2 rounded-full bg-yellow-500 mr-2"></span>
                                        <span class="text-sm">Pending</span>
                                    </label>
                                    <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50 transition">
                                        <input type="radio" name="status" value="2" class="mr-3 accent-red-600" />
                                        <span class="w-2 h-2 rounded-full bg-gray-400 mr-2"></span>
                                        <span class="text-sm">Draft</span>
                                    </label>
                                </div>
                            </div>
                            <div>
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-sm text-gray-500">Total Amount</span>
                                    <span class="text-xs text-red-600">Auto-calculated</span>
                                </div>
                                <div class="flex items-baseline gap-1">
                                    <span class="text-gray-400 text-lg">$</span>
                                    <input id="totalAmount" type="text" readonly value="0.00" class="text-4xl font-bold text-right bg-transparent border-none p-0 w-full focus:outline-none" />
                                </div>
                            </div>
                            <button type="button" id="confirmBookingBtn2" class="w-full py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition font-semibold">
                                Confirm Booking
                            </button>
                        </div>
                    </div>
                </aside>
            </form>
        </div>
    </main>

    <script>
        // Toast helper
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type} show`;
            toast.textContent = message;
            document.getElementById('toastContainer').appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }

        // Elements
        const routeSelect = document.getElementById('routeSelect');
        const pickupSelect = document.getElementById('pickupStop');
        const dropoffSelect = document.getElementById('dropoffStop');
        const addPassengerBtn = document.getElementById('addPassengerBtn');
        const confirmBtn = document.getElementById('confirmBookingBtn');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const passengerBody = document.getElementById('passengerTableBody');
        const totalAmountInput = document.getElementById('totalAmount');

        let passengerCount = 0;
        const PRICE_PER_SEAT = 150000;

        function addPassengerRow() {
            passengerCount++;
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors';
            row.innerHTML = `
                <td class="px-6 py-4">
                    <input type="text" class="passenger-name w-full p-2.5 border rounded-lg dark:bg-gray-800 dark:border-gray-600" placeholder="Full Name" required />
                </td>
                <td class="px-6 py-4">
                    <select class="passenger-gender p-2.5 border rounded-lg dark:bg-gray-800 dark:border-gray-600">
                        <option value="">Select</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                    </select>
                </td>
                <td class="px-6 py-4">
                    <input type="text" class="passenger-seat w-24 p-2.5 border rounded-lg dark:bg-gray-800 dark:border-gray-600 font-medium text-red-600" placeholder="--" maxlength="4" required />
                </td>
                <td class="px-6 py-4 text-right">
                    <button type="button" class="delete-passenger text-gray-400 hover:text-red-500 transition p-1">
                        <span class="material-symbols-outlined">delete</span>
                    </button>
                </td>
            `;
            passengerBody.appendChild(row);

            row.querySelector('.delete-passenger').onclick = () => {
                row.remove();
                passengerCount--;
                updateTotalAmount();
            };

            row.querySelector('.passenger-name').focus();
            updateTotalAmount();
        }

        function updateTotalAmount() {
            const amount = passengerCount * PRICE_PER_SEAT;
            totalAmountInput.value = amount.toFixed(2);
        }

        // Load stops
        routeSelect.addEventListener('change', async () => {
            const routeId = routeSelect.value.trim();
            if (!routeId) {
                pickupSelect.innerHTML = '<option value="">Select pickup point</option>';
                dropoffSelect.innerHTML = '<option value="">Select dropoff point</option>';
                pickupSelect.disabled = true;
                dropoffSelect.disabled = true;
                return;
            }

            pickupSelect.disabled = true;
            dropoffSelect.disabled = true;
            pickupSelect.innerHTML = '<option value="">Loading...</option>';
            dropoffSelect.innerHTML = '<option value="">Loading...</option>';

            try {
                const res = await fetch(`/Admin/Booking/GetStopsByRoute?routeId=${routeId}`);
                if (!res.ok) throw new Error(`Server error ${res.status}`);

                const data = await res.json();

                if (!data.success) throw new Error(data.message || 'Không tải được danh sách điểm dừng');

                const stops = data.stops || [];
                        if (stops.length === 0) {
            pickupSelect.innerHTML = '<option value="">No pickup stops configured</option>';
            dropoffSelect.innerHTML = '<option value="">No dropoff stops configured</option>';
            pickupSelect.disabled = true;
            dropoffSelect.disabled = true;
            showToast('This route has no stops configured', 'error');
            return;
        }
            const options = stops.map(s =>
            `<option value="${s.id}">${s.name}</option>`
        ).join('');

                pickupSelect.innerHTML = `<option value="">Select pickup point</option>${options}`;
                dropoffSelect.innerHTML = `<option value="">Select dropoff point</option>${options}`;

                pickupSelect.disabled = false;
                dropoffSelect.disabled = false;

            } catch (err) {
                console.error('Error loading stops:', err);
                showToast('Unable to load stops: ' + err.message, 'error');
                pickupSelect.innerHTML = '<option value="">Error loading data</option>';
                dropoffSelect.innerHTML = '<option value="">Error loading data</option>';
            }
        });

        // Add passenger initial
        addPassengerBtn.addEventListener('click', addPassengerRow);
        addPassengerRow(); // Default 1 passenger

        // Confirm booking
        confirmBtn.addEventListener('click', async () => {
            confirmBtn.disabled = true;
            loadingSpinner.classList.remove('hidden');
            confirmBtn.textContent = 'Processing...';

            try {
                if (!routeSelect.value) throw new Error('Please select a route');
                if (!pickupSelect.value || !dropoffSelect.value) throw new Error('Please select pickup and dropoff stops');
                if (pickupSelect.value === dropoffSelect.value) throw new Error('Pickup and dropoff cannot be the same');

                        const contactData = $('#contactName').select2('data');

        if (!contactData || contactData.length === 0) {
            throw new Error('Please select a customer');
        }

        const contactName = contactData[0].text; // tên hiển thị


                const passengers = [];
                passengerBody.querySelectorAll('tr').forEach(row => {
                    const name = row.querySelector('.passenger-name')?.value?.trim();
                    const seat = row.querySelector('.passenger-seat')?.value?.trim();
                    if (name && seat) passengers.push({ fullName: name, seatNumber: seat });
                });

                if (passengers.length === 0) throw new Error('Please add at least 1 passenger');

                // Get user ID from selected contact
                const userId = contactData[0].id;

                // Convert status string to int
                const statusValue = document.querySelector('input[name="status"]:checked')?.value;
                const bookingStatus = parseInt(statusValue) || 0;

                const payload = {
                    booking: {
                        userId: userId,
                        tripId: parseInt(routeSelect.value) || 0,  // Using route as trip for now
                        pickupStopId: parseInt(pickupSelect.value) || 0,
                        dropoffStopId: parseInt(dropoffSelect.value) || 0,
                        contactName: contactName,
                        contactEmail: '',
                        contactMobile: '',
                        bookingStatus: bookingStatus,
                        totalAmount: parseFloat(totalAmountInput.value) || 0,
                        createdAt: new Date().toISOString()
                    },
                    passengers
                };

                const res = await fetch('/Admin/Booking/Create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await res.json();

                if (result.success) {
                    showToast('Booking created successfully!', 'success');
                    window.location.href = result.redirectUrl || '/Admin/Booking';
                } else {
                    throw new Error(result.message || 'Failed to create booking');
                }
            } catch (err) {
                showToast('Error: ' + err.message, 'error');
                console.error(err);
            } finally {
                confirmBtn.disabled = false;
                loadingSpinner.classList.add('hidden');
                confirmBtn.textContent = 'Confirm Booking';
            }
        });

        // Secondary confirm button
        document.getElementById('confirmBookingBtn2').addEventListener('click', () => {
            confirmBtn.click();
        });
    </script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="~/dist/js/select2.js"></script>
    <script>
        // Initialize Select2 for customer search after Select2 library is loaded
        $(document).ready(function () {
            $('#contactName').select2({
                placeholder: 'Search by name or ID...',
                allowClear: true,
                width: '100%',
                minimumInputLength: 1,
                ajax: {
                    url: '/Admin/Booking/GetForSelect2',
                    dataType: 'json',
                    delay: 300,
                    data: function (params) {
                        return {
                            q: params.term  // Controller uses 'q' parameter
                        };
                    },
                    processResults: function (data) {
                        return {
                            results: data
                        };
                    },
                    cache: true
                }
            });

            // Sync contact name to summary
            $('#contactName').on('select2:select', function (e) {
                var data = e.params.data;
                document.getElementById('summaryContactName').value = data.text || '';
            });
        });
    </script>

</body>
</html>