@using eBusWeb.Models
@{
    var route = ViewBag.SelectedRoute as eBusWeb.Models.Route;
    var stops = ViewBag.Stops as List<RouteStop> ?? new List<RouteStop>();
}

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<div class="container-fluid py-2 px-2" style="max-width: 1200px; margin-left: 0;">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb mb-2 shadow-none bg-transparent p-0">
            <li class="breadcrumb-item extra-small">
                <a href="/Admin/Dashboard" class="text-decoration-none text-muted"><i class="fa-solid fa-house me-1"></i>Dashboard</a>
            </li>
            <li class="breadcrumb-item extra-small">
                <a href="/Admin/Route" class="text-decoration-none text-muted">Route Management</a>
            </li>
            <li class="breadcrumb-item extra-small active fw-bold text-primary" aria-current="page">Edit</li>
        </ol>
    </nav>
    <div id="routeMessage" class="alert d-none mt-2" role="alert"></div>
    <div class="d-flex justify-content-between align-items-center gap-2 mb-3">
        <div>
            <h6 class="fw-black text-dark mb-0">Edit Route: <span id="displayRouteName">@route?.Name</span></h6>
            <p class="text-muted extra-small mb-0">ID: #@route?.Id | Manage locations and sequence.</p>
        </div>
        <div class="d-flex gap-2">
            <a href="/Admin/Route" class="btn btn-light btn-xs fw-bold border">Back</a>
            <button class="btn btn-outline-danger btn-xs fw-bold" onclick="handleDeleteRoute(@route?.Id)">
                <i class="fa-solid fa-trash-can me-1"></i> Delete Route
            </button>
        </div>
    </div>

    <div class="row g-2">
        <div class="col-xl-8 col-lg-7 order-2 order-lg-1">
            <div class="card border-0 shadow-sm rounded-3">
                <div class="card-body p-2 p-md-3">
                    <div class="d-flex justify-content-between align-items-center mb-3 px-1">
                        <span class="fw-bold extra-small text-uppercase tracking-wider text-muted">
                            <i class="fa-solid fa-route text-primary me-1"></i> Route Stops
                        </span>
                       
                    </div>

                    <div id="stopsContainer" class="position-relative ps-1">
                        <div class="position-absolute border-start border-primary border-2 opacity-25"
                             style="left: 18px; top: 10px; bottom: 10px; z-index: 0;"></div>

                        @if (stops != null && stops.Any())
                        {
                            @foreach (var stop in stops)
                            {
                                <div class="stop-item position-relative ps-4 pb-2" data-id="@stop.Id">
                                    <div class="position-absolute rounded-circle bg-primary border border-white border-2 shadow-sm"
                                         style="left: 6px; top: 10px; width: 10px; height: 10px; z-index: 10;"></div>

                                    <div class="card border border-light-subtle bg-light bg-opacity-25 shadow-none hover-shadow transition-all">
                                        <div class="card-body p-2">
                                            <div class="row g-2 align-items-center">
                                                <div class="col-auto">
                                                    <i class="fa-solid fa-grip-vertical text-muted cursor-grab handle" style="font-size: 0.7rem;"></i>
                                                </div>
                                                <div class="col">
                                                    <label class="d-block text-muted extra-small fw-bold mb-0">STATION NAME</label>
                                                    <input type="text" class="form-control form-control-sm border-0 bg-transparent p-0 shadow-none fw-semibold extra-small stop-location"
                                                           value="@stop.LocationName">
                                                </div>
                                                <div class="col-auto">
                                                    <label class="d-block text-muted extra-small mb-0">TYPE</label>
                                                    <select class="form-select form-select-sm border-0 bg-transparent p-0 shadow-none fw-semibold extra-small stop-type">
                                                        <option value="0" selected="@(stop.StopType == 1)">Pickup</option>
                                                        <option value="1" selected="@(stop.StopType == 2)">Drop-off</option>
                                                        <option value="2" selected="@(stop.StopType == 3)">Waypoint</option>
                                                    </select>
                                                </div>

                                                <div class="col-auto">
                                                    <button class="btn btn-link text-muted p-1 hover-danger" onclick="removeStop(this, @stop.Id)">
                                                        <i class="fa-solid fa-xmark"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        }
                    </div>

                    <button class="btn btn-outline-primary w-100 py-2 border-dashed rounded-2 fw-bold extra-small mt-2" onclick="addNewStop()">
                        <i class="fa-solid fa-plus me-1"></i> Add New Stop
                    </button>
                </div>
            </div>
        </div>

        <div class="col-xl-4 col-lg-5 order-1 order-lg-2">
            <div class="card border-0 shadow-sm rounded-3 sticky-top" style="top: 10px;">
                <div class="card-body p-3">
                    <h6 class="extra-small fw-bold text-uppercase text-muted mb-3">Route Metadata</h6>

                    <div class="mb-2">
                        <label class="form-label extra-small fw-bold text-muted mb-1">Route Display Name</label>
                        <input type="text" id="routeName" class="form-control form-control-sm bg-light border-0 extra-small fw-bold" value="@route?.Name">
                    </div>

                    <div class="row g-2 mb-3">
                        
                        <div class="col-12">
                            <label class="form-label extra-small fw-bold text-muted mb-1">Estimated Duration (Minutes)</label>
                            <div class="input-group input-group-sm">
                                <input type="number" id="routeDuration" class="form-control border-light-subtle extra-small" value="@route?.EstDuration">
                                <span class="input-group-text bg-white extra-small px-2 text-muted">min</span>
                            </div>
                        </div>
                    </div>
                    <div id="mapContainer" style="width:100%; height:300px; max-height:400px; margin-top:20px; transition: all 0.3s;"></div>

                    <div class="d-grid gap-2 mt-4">
                        <button class="btn btn-primary btn-sm fw-bold py-2 shadow-sm" onclick="saveAllData()">
                            <i class="fa-solid fa-floppy-disk me-1"></i> Update All Changes
                        </button>
                        <button class="btn btn-light btn-sm text-muted fw-bold border extra-small" onclick="window.location.reload()">
                            Reset Form
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    function updateRouteMap() {
        // 1. Lấy giá trị từ ô "Route Display Name"
        const routeInput = document.getElementById('routeName');
        if (!routeInput) return;

        const routeValue = routeInput.value.trim(); // vd: "Hải Phòng -> TPHCM"

        // 2. Kiểm tra định dạng có dấu "->" không
        if (routeValue.includes("->")) {
            const parts = routeValue.split("->").map(s => s.trim());
            const start = parts[0];
            const end = parts[parts.length - 1]; // Lấy điểm cuối cùng

            if (start && end) {
                // 3. Tạo URL Google Maps Embed chính xác
                // Sử dụng chế độ "place" hoặc "directions" của Google Maps

                // Nếu KHÔNG CÓ API KEY, sử dụng link search cộng chuỗi (miễn phí):
                const freeUrl = `https://maps.google.com/maps?q=${encodeURIComponent(start)}%20to%20${encodeURIComponent(end)}&output=embed`;

                // 4. Nhúng vào div #mapContainer có sẵn trong HTML của bạn
                const container = document.getElementById('mapContainer');
                    container.innerHTML = `<iframe
        width="100%"
        height="500px"
        style="border:0; border-radius: 8px;"
        src="${freeUrl}"
        allowfullscreen>
    </iframe>`;

            }
        }
    }

    // Chạy khi trang load
    window.addEventListener('load', updateRouteMap);

    // Cập nhật map ngay lập tức khi người dùng sửa tên Route
    document.getElementById('routeName').addEventListener('change', updateRouteMap);
</script>

<script>
    // 1. Khởi tạo Kéo thả (Sortable)
    const el = document.getElementById('stopsContainer');
    if (el) {
        Sortable.create(el, {
            handle: '.handle',
            animation: 150,
            ghostClass: 'bg-light'
        });
    }

    // 2. Thêm Stop mới (Giao diện)
    function addNewStop() {
        const container = document.getElementById('stopsContainer');
        const newStopHtml = `
            <div class="stop-item position-relative ps-4 pb-2" data-id="0">
                <div class="position-absolute rounded-circle bg-success border border-white border-2 shadow-sm"
                     style="left: 6px; top: 10px; width: 10px; height: 10px; z-index: 10;"></div>
                <div class="card border border-success border-opacity-25 bg-white shadow-none transition-all">
                    <div class="card-body p-2">
                        <div class="row g-2 align-items-center">
                            <div class="col-auto"><i class="fa-solid fa-grip-vertical text-muted cursor-grab handle" style="font-size: 0.7rem;"></i></div>
                            <div class="col">
                                <label class="d-block text-success extra-small fw-bold mb-0">NEW LOCATION</label>
                                <input type="text" class="form-control form-control-sm border-0 p-0 shadow-none fw-semibold extra-small stop-location" placeholder="Enter name...">
                            </div>
                            <div class="col-auto">
                                <label class="d-block text-muted extra-small mb-0">TYPE</label>
                                <select class="form-select form-select-sm border-0 p-0 shadow-none fw-semibold extra-small stop-type">
                                    <option value="0">Pickup</option>
                                    <option value="1">Drop-off</option>
                                    <option value="2" selected>Waypoint</option>
                                </select>
                            </div>
                            <div class="col-auto">
                                <button class="btn btn-link text-danger p-1" onclick="removeStop(this, 0)"><i class="fa-solid fa-trash-can"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>`;
        container.insertAdjacentHTML('beforeend', newStopHtml);
    }

    // 3. Xóa Stop (Gọi API)
    async function removeStop(btn, id) {
        if (id === 0) {
            btn.closest('.stop-item').remove();
            return;
        }

        if (confirm("Are you sure you want to delete this stop from database?")) {
            try {
                const response = await fetch('/Admin/Route/DeleteStop', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: id
                });
                const res = await response.json();
                if (res.success) {
                    btn.closest('.stop-item').remove();
                } else {
                    alert("Error: " + res.message);
                }
            } catch (err) {
                alert("Network error occurred.");
            }
        }
    }

    // 4. Lưu toàn bộ (Main Logic)
    async function saveAllData() {
        const routeId = @route?.Id;
        const stopItems = document.querySelectorAll('.stop-item');

        const payload = {
            Id: routeId,
            Name: document.getElementById('routeName').value,
            EstDuration: parseInt(document.getElementById('routeDuration').value) || 0,
            Stops: []
        };

        // Duyệt qua danh sách Stop theo thứ tự hiện tại trên giao diện
        stopItems.forEach((item, index) => {
            payload.Stops.push({
                Id: parseInt(item.getAttribute('data-id')),
                RouteId: routeId,
                LocationName: item.querySelector('.stop-location').value,
                StopType: parseInt(item.querySelector('.stop-type').value),
                StopOrder: index + 1 // Tự động cập nhật thứ tự từ 1..N
            });
        });

        try {
            const response = await fetch('/Admin/Route/SaveRouteAndStops', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const result = await response.json();
            if (result.success) {
                alert("Route and stops updated successfully!");
                window.location.reload();
            } else {
                alert("Failed: " + result.message);
            }
        } catch (err) {
            console.error(err);
            alert("Error saving data. Check console.");
        }
    }
</script>
<style>
    #mapContainer {
        width: 100%;
        height: 300px;
        max-height: 400px;
        margin-top: 20px;
        transition: all 0.3s ease-in-out;
        border-radius: 8px;
        overflow: hidden;
    }

        #mapContainer:hover {
            height: 500px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
</style>


<script>

    async function deleteRoute(routeId) {
        if (!routeId) return;

        if (!confirm('Are you sure you want to delete this route? This action cannot be undone.')) {
            return;
        }

        const messageDiv = document.getElementById('routeMessage');

        try {
            const res = await fetch('/Admin/Route/Delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ Id: routeId }) // Gửi object JSON
            });

            const data = await res.json();

            if (data.success) {
                messageDiv.className = 'alert alert-success';
                messageDiv.textContent = data.message || 'Route deleted successfully!';
                messageDiv.classList.remove('d-none');

                // Reload hoặc redirect về trang danh sách routes
                setTimeout(() => window.location.href = '/Admin/Route/Index', 1500);
            } else {
                messageDiv.className = 'alert alert-danger';
                messageDiv.textContent = data.message || 'Error deleting route';
                messageDiv.classList.remove('d-none');
            }
        } catch (err) {
            messageDiv.className = 'alert alert-danger';
            messageDiv.textContent = 'Server error: ' + err.message;
            messageDiv.classList.remove('d-none');
        }
    }
</script>

<script>
    async function handleDeleteRoute(routeId) {
        if (!routeId) return;

        // Thêm modal xác nhận hoặc alert đơn giản
        if (!confirm("Are you sure you want to delete this route? All associated stops will also be deleted.")) {
            return;
        }

        const messageDiv = document.getElementById('routeMessage');

        try {
            // Gọi API POST giống Controller
            const response = await fetch('/Admin/Route/Delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ Id: routeId })
            });

            const data = await response.json();

            if (data.success) {
                messageDiv.className = 'alert alert-success';
                messageDiv.textContent = data.message || 'Route deleted successfully!';
                messageDiv.classList.remove('d-none');

                // Redirect về danh sách route sau 1.5 giây
                setTimeout(() => window.location.href = '/Admin/Route/Index', 1500);
            } else {
                messageDiv.className = 'alert alert-danger';
                messageDiv.textContent = data.message || 'Error deleting route';
                messageDiv.classList.remove('d-none');
            }
        } catch (err) {
            messageDiv.className = 'alert alert-danger';
            messageDiv.textContent = 'Server error: ' + err.message;
            messageDiv.classList.remove('d-none');
        }
    }
</script>