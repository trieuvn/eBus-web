<div class="container-fluid py-3 px-4">
    <div id="routeMessage" class="alert d-none" role="alert"></div>
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-1">
                    <li class="breadcrumb-item small"><a href="/Admin/Dashboard" class="text-decoration-none text-muted"><i class="fa-solid fa-house me-1"></i>Dashboard</a></li>
                    <li class="breadcrumb-item small active fw-bold text-primary" aria-current="page">Route Management</li>
                </ol>
            </nav>
            <div class="d-flex justify-content-between align-items-center">
                <h4 class="fw-bold mb-0">Route Administration</h4>
               <a href="/Admin/Route/Create" class="btn btn-primary shadow-sm btn-sm px-3">
                    <i class="fa-solid fa-plus me-1"></i> Create Route
                </a>
            </div>
        </div>
    </div>

    <div class="row g-3">
        <div class="col-lg-4 col-xl-3">
            <div class="card border-0 shadow-sm overflow-hidden">
                <div class="p-3 border-bottom bg-light">
                    <form method="get" class="mb-2">
                        <div class="input-group input-group-sm">
                            <span class="input-group-text bg-white border-end-0">
                                <i class="fa-solid fa-search text-muted"></i>
                            </span>
                            <input type="text"
                                   name="search"
                                   value="@Context.Request.Query["search"]"
                                   class="form-control border-start-0"
                                   placeholder="Find a route...">
                        </div>
                    </form>

                </div>

                <div class="list-group list-group-flush route-sidebar">
                    @if (ViewBag.Routes != null)
                    {
                        foreach (var r in ViewBag.Routes)
                        {
                            var isSelected = (ViewBag.SelectedRoute != null && r.Id == ViewBag.SelectedRoute.Id);
                            <a href="@Url.Action("Index", "Route", new { area = "Admin", id = r.Id, page = ViewBag.CurrentPage })"
                               class="list-group-item list-group-item-action @(isSelected ? "active" : "")">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="fw-bold">@r.Name</span>
                                    @if (isSelected)
                                    {
                                        <span class="badge bg-primary-subtle text-primary small" style="font-size: 0.65rem;">SELECTED</span>
                                    }
                                </div>
                                <div class="small text-muted mt-1">
                                    <i class="fa-regular fa-clock me-1"></i> @(r.EstDuration / 60)h @(r.EstDuration % 60)m
                                </div>
                            </a>
                        }
                    }
                </div>

               @if (ViewBag.TotalPages > 1)
{
    int totalPages = ViewBag.TotalPages;
    int currentPage = ViewBag.CurrentPage;

    int startPage;
    int endPage;

    if (totalPages <= 4)
    {
        startPage = 2;
        endPage = totalPages - 1;
    }
    else if (currentPage <= 2)
    {
        startPage = 2;
        endPage = 2;
    }
    else if (currentPage >= totalPages - 1)
    {
        startPage = totalPages - 1;
        endPage = totalPages - 1;
    }
    else
    {
        startPage = currentPage;
        endPage = currentPage;
    }

    <div class="card-footer bg-white border-top p-2">
        <nav>
            <ul class="pagination pagination-sm justify-content-center mb-0">

                <!-- PREV -->
                <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                    <a class="page-link border-0"
                       href="@Url.Action("Index", new {
                           page = currentPage - 1,
                           id = ViewBag.SelectedRoute?.Id,
                           search = ViewBag.Search
                       })">
                        <i class="fa-solid fa-chevron-left"></i>
                    </a>
                </li>

                <!-- PAGE 1 -->
                <li class="page-item @(currentPage == 1 ? "active" : "")">
                    <a class="page-link border-0 mx-1 rounded shadow-sm"
                       href="@Url.Action("Index", new {
                           page = 1,
                           id = ViewBag.SelectedRoute?.Id,
                           search = ViewBag.Search
                       })">1</a>
                </li>

                <!-- ... BEFORE -->
                @if (startPage > 2)
                {
                    <li class="page-item disabled">
                        <span class="page-link border-0">...</span>
                    </li>
                }

                <!-- MIDDLE PAGE(S) -->
                @for (int i = startPage; i <= endPage; i++)
                {
                    if (i > 1 && i < totalPages)
                    {
                        <li class="page-item @(currentPage == i ? "active" : "")">
                            <a class="page-link border-0 mx-1 rounded shadow-sm"
                               href="@Url.Action("Index", new {
                                   page = i,
                                   id = ViewBag.SelectedRoute?.Id,
                                   search = ViewBag.Search
                               })">@i</a>
                        </li>
                    }
                }

                <!-- ... AFTER -->
                @if (endPage < totalPages - 1)
                {
                    <li class="page-item disabled">
                        <span class="page-link border-0">...</span>
                    </li>
                }

                <!-- LAST PAGE -->
                <li class="page-item @(currentPage == totalPages ? "active" : "")">
                    <a class="page-link border-0 mx-1 rounded shadow-sm"
                       href="@Url.Action("Index", new {
                           page = totalPages,
                           id = ViewBag.SelectedRoute?.Id,
                           search = ViewBag.Search
                       })">@totalPages</a>
                </li>

                <!-- NEXT -->
                <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                    <a class="page-link border-0"
                       href="@Url.Action("Index", new {
                           page = currentPage + 1,
                           id = ViewBag.SelectedRoute?.Id,
                           search = ViewBag.Search
                       })">
                        <i class="fa-solid fa-chevron-right"></i>
                    </a>
                </li>

            </ul>
        </nav>
    </div>
}


            </div>
        </div>
   
        <div class="col-lg-8 col-xl-9">
            @if (ViewBag.SelectedRoute != null)
            {
                <div class="card border-0 shadow-sm mb-3">
                    <div class="card-body p-4">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h6 class="fw-bold mb-0 text-uppercase tracking-wider text-muted">General Information</h6>
                            <div class="d-flex gap-2">
                               <button class="btn btn-primary btn-sm px-4 shadow-sm" onclick="saveRouteAndStops(@ViewBag.SelectedRoute.Id)">
                                    Save Changes
                                </button>

                                <button type="button" 
                                        onclick="window.location.href='/Admin/Route/Edit/@ViewBag.SelectedRoute.Id'" 
                                        class="btn btn-outline-secondary btn-sm px-4 shadow-sm">
                                    <i class="fa-solid fa-pen-to-square me-2"></i>
                                    Edit Route Stop
                                </button>
                            </div>

                        </div>
                        <div class="row g-3">
                                <div class="col-md-8">
                                    <label class="form-label small fw-bold" for="routeName">Route Name</label>
                                    <input id="routeName" class="form-control bg-light border-0 px-3 py-2" 
                                           value="@ViewBag.SelectedRoute.Name" />
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label small fw-bold" for="routeDuration">Duration (Min)</label>
                                    <input id="routeDuration" class="form-control bg-light border-0 px-3 py-2" 
                                           value="@ViewBag.SelectedRoute.EstDuration" />
                                </div>
                            </div>

                    </div>
                </div>

                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                        <h6 class="fw-bold mb-0">Stops Sequence</h6>
                        <button class="btn btn-outline-primary btn-sm px-3 border-dashed"><i class="fa-solid fa-plus me-1"></i>Add Stop</button>
                    </div>
                    <div class="table-responsive">
                        <table class="table align-middle mb-0">
                            <thead class="table-light">
                                <tr class="small text-muted">
                                    <th class="ps-4" style="width: 80px;">ORDER</th>
                                    <th>LOCATION</th>
                                    <th class="text-end pe-4">ACTION</th>
                                </tr>
                            </thead>
                            <tbody id="stopsTableBody">
                                @if (ViewBag.Stops != null && ViewBag.Stops.Count > 0)
                                {
                                    foreach (var stop in ViewBag.Stops)
                                    {
                                        <tr data-stop-id="@stop.Id">
                                            <td class="ps-4">
                                                <span class="d-inline-flex align-items-center justify-content-center 
                                                             rounded-circle bg-secondary-subtle text-dark fw-bold"
                                                      style="width:32px; height:32px;">@stop.StopOrder
                                                </span>
                                            </td>
                                            <td>
                                               
                                                <div class="d-flex align-items-center mt-1">
                                                    <div class="stop-icon @(stop.StopType == 1 ? "bg-blue-light" : stop.StopType == 3 ? "bg-red-light" : "bg-purple-light") me-3">
                                                        <i class="fa-solid @(stop.StopType == 1 ? "fa-bus" : stop.StopType == 3 ? "fa-moon" : "fa-train")"></i>
                                                    </div>
                                                    <div>
                                                        <div class="fw-bold small">@stop.LocationName</div>
                                                        <div class="text-muted" style="font-size: 0.75rem;">
                                                            Type: @(stop.StopType == 1 ? "Express" : stop.StopType == 3 ? "Overnight" : "Standard")
                                                        </div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td class="text-end pe-4">
                                                <button class="btn-action-small ms-1 text-danger"
                                                        onclick="openDeleteModal(@stop.Id, this.closest('tr'))">
                                                    <i class="fa-solid fa-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    }
                                }
                            </tbody>

                        </table>
                    </div>
                </div>
            }
            else
            {
                <div class="card border-0 shadow-sm p-5 text-center">
                    <i class="fa-solid fa-route fa-3x text-light mb-3"></i>
                    <p class="text-muted">Please select a route to manage its details.</p>
                </div>
            }
            <div class="delete-container d-flex justify-content-between align-items-center mt-4">
                <div class="delete-text">
                    <h6 class="fw-bold text-danger mb-1">Delete Route</h6>
                    <p class="text-muted mb-0" style="font-size: 0.9rem;">
                        This action cannot be undone. All associated bookings and schedule data will be permanently removed.
                    </p>
                </div>
                <button type="button" 
                        class="btn btn-outline-danger btn-delete-custom" 
                        style="width: 200px;"
                        onclick="deleteRoute(@ViewBag.SelectedRoute.Id)">
                    Delete Route
                </button>

            </div>
        </div>
    </div>
</div>
<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header border-0">
        <h5 class="modal-title">Confirm Delete</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Are you sure you want to delete this stop?
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
        <button type="button" id="confirmDeleteBtn" class="btn btn-danger btn-sm">Delete</button>
      </div>
    </div>
  </div>
</div>
<style>
    .delete-container {
        background-color: #fff5f5; /* Màu nền hồng nhạt */
        border: 1px solid #ffe3e3; /* Viền hồng nhạt */
        border-radius: 12px;       /* Bo góc */
        padding: 20px 25px;        /* Khoảng cách bên trong */
    }

    .btn-delete-custom {
        background-color: white;
        border: 1px solid #dee2e6;
        color: #dc3545;
        font-weight: 600;
        padding: 8px 20px;
        border-radius: 8px;
        transition: all 0.2s;
    }

    .btn-delete-custom:hover {
        background-color: #dc3545;
        color: white;
        border-color: #dc3545;
    }

    .text-danger {
        color: #a52a2a !important; /* Màu chữ đỏ đậm giống hình */
    }
</style>
<style>

    /* Tinh chỉnh Breadcrumb */
    .breadcrumb-item + .breadcrumb-item::before {
        content: "\f105"; /* Icon angle-right từ FontAwesome */
        font-family: "Font Awesome 6 Free";
        font-weight: 900;
        font-size: 0.7rem;
        color: #adb5bd;
    }

    .breadcrumb-item a {
        color: #6c757d;
        text-decoration: none;
        transition: color 0.2s;
    }

        .breadcrumb-item a:hover {
            color: #0d6efd;
        }

    /* Route Sidebar Styling */
    .route-sidebar .list-group-item {
        border: none;
        padding: 1rem;
        border-bottom: 1px solid #f1f3f5;
        transition: all 0.2s;
    }

        .route-sidebar .list-group-item.active {
            background-color: #fff !important;
            color: #212529 !important;
            border-left: 4px solid #9d4edd; /* Màu tím giống avatar của bạn */
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.05);
            z-index: 2;
        }

            .route-sidebar .list-group-item.active .text-muted {
                color: #9d4edd !important;
            }

    /* Trạng thái điểm dừng */
    .stop-icon {
        width: 34px;
        height: 34px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        font-size: 0.9rem;
    }

    .bg-blue-light {
        background-color: #e3f2fd;
        color: #0d6efd;
    }

    .bg-purple-light {
        background-color: #f3e5f5;
        color: #9d4edd;
    }

    .btn-action-small {
        width: 28px;
        height: 28px;
        padding: 0;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 6px;
        border: 1px solid #dee2e6;
        background: white;
        color: #6c757d;
    }
</style>

<script>
async function saveRouteAndStops(routeId) {
    const name = document.getElementById('routeName').value;
    const duration = parseInt(document.getElementById('routeDuration').value);

    // Lấy danh sách Stops
    const rows = document.querySelectorAll('#stopsTableBody tr');
    const stopsPayload = [];

    rows.forEach((row, index) => {
        const stopId = parseInt(row.dataset.stopId);
        let locationInput = row.querySelector('.stop-name');
            let locationName;
            if(locationInput){
                locationName = locationInput.value;
            }else{
                // lấy text từ div
                locationName = row.querySelector('.fw-bold.small').textContent.trim();
            }
        stopsPayload.push({
            Id: stopId > 0 ? stopId : 0, // 0 = mới
            RouteId: routeId,
            LocationName: locationName,
            StopOrder: index + 1
        });
    });

    const payload = {
        Id: routeId,
        Name: name,
        EstDuration: duration,
        Stops: stopsPayload
    };

    const messageDiv = document.getElementById('routeMessage');

    try {
        const res = await fetch('/Admin/Route/SaveRouteAndStops', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        const data = await res.json();

        if (data.success) {
            messageDiv.className = 'alert alert-success';
            messageDiv.textContent = 'Route and stops saved successfully!';
            messageDiv.classList.remove('d-none');

            setTimeout(() => messageDiv.classList.add('d-none'), 3000);
            setTimeout(() => window.location.reload(), 1500);
        } else {
            messageDiv.className = 'alert alert-danger';
            messageDiv.textContent = data.message || 'Error saving route/stops';
            messageDiv.classList.remove('d-none');
        }
    } catch (err) {
        messageDiv.className = 'alert alert-danger';
        messageDiv.textContent = 'Server error: ' + err.message;
        messageDiv.classList.remove('d-none');
    }
}
</script>




<script>
    // Biến toàn cục lưu stop cần xóa và row
    let stopToDelete = null;
    let rowToDelete = null;

    // Hàm hiển thị thông báo tạm thời (nếu chưa có admin.js)
    function showNotification(message, type) {
        const msgDiv = document.getElementById('routeMessage');
        msgDiv.className = 'alert alert-' + type;
        msgDiv.textContent = message;
        msgDiv.classList.remove('d-none');
        setTimeout(() => msgDiv.classList.add('d-none'), 3000);
    }

    // Mở modal confirm delete
    function openDeleteModal(stopId, rowElement) {
        stopToDelete = stopId;
        rowToDelete = rowElement;

        const modal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
        modal.show();
    }

    // Khi bấm Delete trong modal
    document.getElementById('confirmDeleteBtn').addEventListener('click', async function () {
        if (!stopToDelete) return;

        try {
            const res = await fetch('/Admin/Route/DeleteStop', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(stopToDelete) // Gửi trực tiếp số stopId
            });

            const data = await res.json();

            if (data.success) {
                // Xóa row khỏi bảng
                if (rowToDelete) rowToDelete.remove();

                // Hiển thị notification
                showNotification(data.message || 'Stop deleted', 'success');
            } else {
                showNotification(data.message || 'Error deleting stop', 'danger');
            }
        } catch (err) {
            showNotification('Server error: ' + err.message, 'danger');
        }

        // Ẩn modal và reset
        const modalEl = document.getElementById('deleteConfirmModal');
        const modal = bootstrap.Modal.getInstance(modalEl);
        modal.hide();
        stopToDelete = null;
        rowToDelete = null;
    });
</script>


<script>
let newStopIdCounter = -1; // ✨ Thêm biến này trước khi dùng

document.querySelector(".btn-outline-primary").addEventListener('click', function () {
    const tbody = document.getElementById('stopsTableBody');

    // Kiểm tra nếu có input trống
    const emptyInput = Array.from(tbody.querySelectorAll('input.stop-name'))
                            .find(input => input.value.trim() === '');
    if (emptyInput) {
        alert("Please fill in the stop name before adding a new one.");
        emptyInput.focus();
        return;
    }

    const currentCount = tbody.querySelectorAll('tr:not(.no-stops-row)').length;
    const newStopOrder = currentCount + 1;

    const tr = document.createElement('tr');
    tr.setAttribute('data-stop-id', newStopIdCounter--);
    tr.classList.add('new-stop');

    tr.innerHTML = `
        <td class="ps-4">
            <span class="d-inline-flex align-items-center justify-content-center 
                        rounded-circle bg-secondary-subtle text-dark fw-bold"
                  style="width:32px; height:32px;">${newStopOrder}</span>
        </td>
        <td>
            <input type="text" class="form-control form-control-sm stop-name" placeholder="New Stop Name" />
        </td>
        `;

    tbody.appendChild(tr);
    checkNoStopsMessage();

    // focus input mới
    tr.querySelector('input.stop-name').focus();
});
</script>
<script>
    function checkNoStopsMessage() {
    const tbody = document.getElementById('stopsTableBody');
    let messageRow = tbody.querySelector('.no-stops-row');

    if (tbody.querySelectorAll('tr').length === 0) {
        if (!messageRow) {
            const tr = document.createElement('tr');
            tr.classList.add('no-stops-row');
            tr.innerHTML = `<td colspan="3" class="text-center py-5 text-muted">No stops found.</td>`;
            tbody.appendChild(tr);
        }
    } else {
        if (messageRow) messageRow.remove();
    }
}

// Gọi khi trang load
checkNoStopsMessage();
</script>
<script>
async function deleteRoute(routeId) {
    if (!confirm("Are you sure you want to delete this route?")) return;

    try {
        const res = await fetch('/Admin/Route/Delete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ Id: routeId })
        });

        const data = await res.json();

        if (data.success) {
            alert(data.message || 'Route deleted successfully!');
            // Reload page để cập nhật list routes
            window.location.href = '/Admin/Route/Index';
        } else {
            alert(data.message || 'Error deleting route');
        }
    } catch (err) {
        alert('Server error: ' + err.message);
    }
}
</script>
